<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Applio Installer</title>
  <link href='https://fonts.googleapis.com/css?family=Inter' rel='stylesheet'>
  <link rel="stylesheet" href="./styles/index.css">
  <link rel="stylesheet" href="./styles/install.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
  <h1>Applio installer</h1>
  <h4>The solution to everything is <span>üçè</span></h4>
  <br>
  <form id="installForm">
    <label for="installationPath">Installation path:</label>
    <input type="text" id="installationPath" name="installationPath">
    <button type="button" onclick="cloneRepository()">Install</button>
  </form>
  <br>
  <textarea id="consoleOutput" rows="10" cols="55" readonly></textarea>
  <div id="installationComplete" style="display: none;">
    <h2><span class="gradiant">Applio </span>üçè has been installed successfully!</h2>
  </div>
  <!-- BUTTONS -->
  <div class="btn-return" id="return"><i class="fas fa-arrow-left"></i></div>
  <div class="btn-next" id="next" onclick="navigateToNextPage()" style="pointer-events: none; opacity: 0.5 !important;"><i class="fas fa-arrow-right"></i></div>

  <script>
    // Declarar installationCompleteDiv como variable global
    const installationCompleteDiv = document.getElementById("installationComplete");

    function enableNextButton() {
      const nextButton = document.getElementById("next");
      nextButton.style.pointerEvents = "auto";
      nextButton.style.opacity = "1";
    }
    
    function navigateToNextPage() {
  const installationPath = document.getElementById("installationPath").value;
  window.location.href = `install2.html?path=${encodeURIComponent(installationPath)}`;
}
    
    function cloneRepository() {
      const repositoryUrl = "https://github.com/IAHispano/Applio-RVC-Fork.git"; 
      const installationPath = document.getElementById("installationPath").value;
    
      if (installationPath.trim() === "") {
        alert("Please enter a valid installation path.");
        return;
      }
    
      const { spawn } = require('child_process');
      const consoleOutput = document.getElementById("consoleOutput");
    
      const childProcess = spawn('git', ['clone', repositoryUrl, installationPath]);
    
      childProcess.stdout.on('data', (data) => {
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
        consoleOutput.value += data.toString();
      });
    
      childProcess.stderr.on('data', (data) => {
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
        consoleOutput.value += data.toString();
      });
    
      childProcess.on('close', (code) => {
        consoleOutput.value += `Cloning process completed with exit code ${code}\n`;
    
        if (code === 0) {
          consoleOutput.value += "Finished cloning repository\n";
    
          const pipInstallCommand = spawn('pip', ['install', '-r', 'requirements.txt'], { cwd: installationPath, shell: true });
    
          pipInstallCommand.stdout.on('data', (data) => {
            consoleOutput.value += data.toString();
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
          });
    
          pipInstallCommand.stderr.on('data', (data) => {
            consoleOutput.value += data.toString();
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
          });
    
          pipInstallCommand.on('close', (pipCode) => {
            consoleOutput.value += `Pip install command completed with exit code ${pipCode}\n`;
            consoleOutput.value += "Finished install requirements\n";
    
            installationCompleteDiv.style.display = "block";
            enableNextButton(); 
    
            sessionStorage.setItem("installationCompleted", "true");
          });
        }
      });
    }
    
    if (sessionStorage.getItem("installationCompleted") === "true") {
      enableNextButton();
      installationCompleteDiv.style.display = "block";
    }
  </script>
  <script>
    document.getElementById("return").addEventListener("click", function () {
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
