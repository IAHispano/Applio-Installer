<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Applio Installer</title>
  <link href='https://fonts.googleapis.com/css?family=Inter' rel='stylesheet'>
  <link rel="stylesheet" href="./styles/index.css">
  <link rel="stylesheet" href="./styles/install.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
  <h1>Applio</h1>
  <h4>The solution to everything is <span>üçè</span></h4>
  <br>
  <form id="installForm">
    <label for="installationPath">Installation path:</label>
    <input type="text" id="installationPath" name="installationPath">
    <button type="button" onclick="cloneRepositoryAndExecuteBat()">Install</button>
  </form>
  <br>
  <textarea id="consoleOutput" rows="12" cols="65" readonly></textarea>
  <div id="installationComplete" style="display: none;">
    <h2><span class="gradiant" id="installationComplete">Applio </span>üçè has been installed successfully!</h2>
  </div>
  <div id="installationWait" style="display: none;">
    <h2 style="font-size: 10px">This procedure may require a significant amount of time and could potentially result in a temporary reduction in your computer's performance...</h2>
  </div>
  <!-- BUTTONS -->
  <div class="btn-return" id="return"><i class="fas fa-arrow-left"></i></div>
  <div class="btn-next" id="next" onclick="navigateToNextPage()" style="pointer-events: none; opacity: 0.5 !important;"><i class="fas fa-arrow-right"></i></div>

  <script>
    const desktopPath = require('os').homedir() + "\\Desktop\\Applio-RVC-Fork";
    document.getElementById("installationPath").value = desktopPath;
    const installationCompleteDiv = document.getElementById("installationComplete");
    const installationWaitDiv = document.getElementById("installationWait");
    const { spawn } = require('child_process');
    

    function enableNextButton() {
      const nextButton = document.getElementById("next");
      nextButton.style.pointerEvents = "auto";
      nextButton.style.opacity = "1";
    }
    
    function navigateToNextPage() {
  const installationPath = document.getElementById("installationPath").value;
  window.location.href = `install2.html?path=${encodeURIComponent(installationPath)}`;
}
    
  
    function cloneRepositoryAndExecuteBat() {
    const repositoryUrl = "https://github.com/IAHispano/Applio-Installer.git"; 
  const installationPath = document.getElementById("installationPath").value;
  const branchName = "bat";
  if (installationPath.trim() === "") {
    alert("Please enter a valid installation path.");
    return;
  }
  installationWaitDiv.style.display = "block";
  const consoleOutput = document.getElementById("consoleOutput");

  const childProcess = spawn('git', ['clone', '-b', branchName, repositoryUrl, installationPath]);

  childProcess.stdout.on('data', (data) => {
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
    consoleOutput.value += data.toString();
  });

  childProcess.stderr.on('data', (data) => {
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
    consoleOutput.value += data.toString();
  });

  childProcess.on('close', (code) => {
    consoleOutput.value += `Cloning process completed with exit code ${code}\n`;

    if (code === 0) {
      consoleOutput.value += "Finished cloning repository\n";

      const batFilePath = `${installationPath}/install_Applio.bat`; 
      process.chdir(installationPath);
      const batExecution = spawn('cmd.exe', ['/c', batFilePath]);


        batExecution.stdout.on('data', (data) => {
          consoleOutput.value += data.toString();
          consoleOutput.scrollTop = consoleOutput.scrollHeight;
        });

      batExecution.stderr.on('data', (data) => {
        consoleOutput.value += data.toString();
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
      });

      batExecution.on('close', (batCode) => {
        consoleOutput.value += `Batch file execution completed with exit code ${batCode}\n`;

        installationWaitDiv.style.display = "none";
        installationCompleteDiv.style.display = "block";
        enableNextButton(); 

        sessionStorage.setItem("installationCompleted", "true");
      });
    }
  });
}
    if (sessionStorage.getItem("installationCompleted") === "true") {
      enableNextButton();
      installationCompleteDiv.style.display = "block";
    }
  
    
  </script>
  <script>
    document.getElementById("return").addEventListener("click", function () {
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
